@*
    DT_PODSystem/Areas/Security/Views/SecurityRoles/Details.cshtml
    Security Role Details View - Using Standard Panel Layout
*@

@model DT_PODSystem.Areas.Security.Models.ViewModels.SecurityRoleManagementViewModel
@{
    ViewData["Title"] = ViewBag.Title ?? $"Security Role Details - {Model.Name}";
}

<!-- BEGIN breadcrumb -->
<ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Dashboard", new { area = "Security" })">Security</a></li>
    <li class="breadcrumb-item"><a href="@Url.Action("Index")">Roles</a></li>
    <li class="breadcrumb-item active">@Model.Name</li>
</ol>
<!-- END breadcrumb -->
<!-- BEGIN page-header -->
<h1 class="page-header">Security Role Details <small>@Model.Name</small></h1>
<!-- END page-header -->
<!-- BEGIN row -->
<div class="row">
    <!-- BEGIN statistics cards -->
    <div class="col-xl-3 col-md-6">
        <div class="widget widget-stats bg-blue">
            <div class="stats-icon"><i class="fa fa-users"></i></div>
            <div class="stats-info">
                <h4>Assigned Users</h4>
                <p id="userCount">@Model.UserCount</p>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="widget widget-stats bg-green">
            <div class="stats-icon"><i class="fa fa-key"></i></div>
            <div class="stats-info">
                <h4>Permissions</h4>
                <p id="permissionCount">@Model.PermissionCount</p>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="widget widget-stats bg-orange">
            <div class="stats-icon"><i class="fa fa-chart-line"></i></div>
            <div class="stats-info">
                <h4>Activity Score</h4>
                <p id="activityScore">-</p>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="widget widget-stats bg-red">
            <div class="stats-icon"><i class="fa fa-@(Model.IsActive ? "check" : "pause")-circle"></i></div>
            <div class="stats-info">
                <h4>Status</h4>
                <p>@(Model.IsActive ? "Active" : "Inactive")</p>
            </div>
        </div>
    </div>
    <!-- END statistics cards -->
</div>
<!-- END row -->
<!-- BEGIN row -->
<div class="row">
    <div class="col-xl-8">
        <!-- BEGIN panel - Role Information -->
        <div class="panel panel-inverse">
            <div class="panel-heading">
                <h4 class="panel-title">Role Information</h4>
                <div class="panel-heading-btn">
                    <a href="@Url.Action("Edit", new { id = Model.Id })" class="btn btn-xs btn-icon btn-warning" title="Edit Role">
                        <i class="fa fa-edit"></i>
                    </a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload"><i class="fa fa-redo"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse"><i class="fa fa-minus"></i></a>
                </div>
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-8">
                        <h4 class="mb-2">@Model.Name</h4>
                        <div class="mb-3">
                            @if (Model.IsActive)
                            {
                                <span class="badge bg-success me-2">
                                    <i class="fa fa-check-circle me-1"></i>Active
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-secondary me-2">
                                    <i class="fa fa-pause-circle me-1"></i>Inactive
                                </span>
                            }

                            @if (Model.IsSystemRole)
                            {
                                <span class="badge bg-danger">
                                    <i class="fa fa-lock me-1"></i>System Role
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-info">
                                    <i class="fa fa-user-cog me-1"></i>Custom Role
                                </span>
                            }
                        </div>

                        <div class="mb-3">
                            <strong>Description:</strong><br>
                            @if (!string.IsNullOrEmpty(Model.Description))
                            {
                                <p class="mb-0">@Model.Description</p>
                            }
                            else
                            {
                                <p class="text-muted mb-0">
                                    <em>No description provided for this role.</em>
                                </p>
                            }
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-2">
                            <strong>Created:</strong><br>
                            <span class="text-muted">@Model.CreatedAt.ToString("MMM dd, yyyy")</span><br>
                            <small class="text-muted">by @(Model.CreatedBy ?? "System")</small>
                        </div>
                        @if (Model.UpdatedAt != Model.CreatedAt)
                        {
                            <div class="mb-2">
                                <strong>Last Updated:</strong><br>
                                <span class="text-muted">@Model.UpdatedAt.ToString("MMM dd, yyyy")</span><br>
                                <small class="text-muted">by @(Model.UpdatedBy ?? "System")</small>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
        <!-- END panel -->
        <!-- BEGIN panel - Assigned Permissions -->
        <div class="panel panel-inverse">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <i class="fa fa-key me-2"></i>Assigned Permissions
                    <span class="badge bg-theme ms-2" id="permissionsBadge">@Model.PermissionCount</span>
                </h4>
                <div class="panel-heading-btn">
                    <a href="@Url.Action("RolePermissions", new { roleId = Model.Id })" class="btn btn-xs btn-icon btn-success" title="Manage Permissions">
                        <i class="fa fa-cog"></i>
                    </a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload"><i class="fa fa-redo"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse"><i class="fa fa-minus"></i></a>
                </div>
            </div>
            <div class="panel-body">
                <div id="permissionsContainer">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-theme" role="status">
                            <span class="visually-hidden">Loading permissions...</span>
                        </div>
                        <div class="mt-2 small">Loading permissions...</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END panel -->
        <!-- BEGIN panel - Recent Activity -->
        <div class="panel panel-inverse">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <i class="fa fa-clock me-2"></i>Recent Activity
                </h4>
                <div class="panel-heading-btn">
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload"><i class="fa fa-redo"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse"><i class="fa fa-minus"></i></a>
                </div>
            </div>
            <div class="panel-body">
                <div id="recentActivityContainer">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-theme" role="status">
                            <span class="visually-hidden">Loading activity...</span>
                        </div>
                        <div class="mt-2 small">Loading recent activity...</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END panel -->
    </div>

    <div class="col-xl-4">
        <!-- BEGIN panel - Quick Actions -->
        <div class="panel panel-inverse">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <i class="fa fa-tools me-2"></i>Quick Actions
                </h4>
                <div class="panel-heading-btn">
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse"><i class="fa fa-minus"></i></a>
                </div>
            </div>
            <div class="panel-body">
                <div class="d-grid gap-2">
                    <a href="@Url.Action("RolePermissions", new { roleId = Model.Id })" class="btn btn-outline-success">
                        <i class="fa fa-key me-2"></i>Manage Permissions
                    </a>
                    <a href="@Url.Action("Index", "SecurityUsers", new { roleId = Model.Id })" class="btn btn-outline-info">
                        <i class="fa fa-users me-2"></i>View Assigned Users
                    </a>
                    <a href="@Url.Action("Edit", new { id = Model.Id })" class="btn btn-outline-warning">
                        <i class="fa fa-edit me-2"></i>Edit Role Settings
                    </a>
                    <button type="button" class="btn btn-outline-primary" onclick="exportRoleReport()">
                        <i class="fa fa-chart-line me-2"></i>Generate Analytics
                    </button>
                    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                        <i class="fa fa-arrow-left me-2"></i>Back to List
                    </a>
                </div>
            </div>
        </div>
        <!-- END panel -->
        <!-- BEGIN panel - Assigned Users -->
        <div class="panel panel-inverse">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <i class="fa fa-users me-2"></i>Assigned Users
                    <span class="badge bg-theme ms-2" id="usersBadge">@Model.UserCount</span>
                </h4>
                <div class="panel-heading-btn">
                    @if (Model.UserCount > 0)
                    {
                        <a href="@Url.Action("Index", "SecurityUsers", new { roleId = Model.Id })" class="btn btn-xs btn-icon btn-info" title="View All Users">
                            <i class="fa fa-eye"></i>
                        </a>
                    }
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload"><i class="fa fa-redo"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse"><i class="fa fa-minus"></i></a>
                </div>
            </div>
            <div class="panel-body">
                <div id="usersContainer">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-theme" role="status">
                            <span class="visually-hidden">Loading users...</span>
                        </div>
                        <div class="mt-2 small">Loading users...</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END panel -->
        <!-- BEGIN panel - Usage Analytics -->
        <div class="panel panel-inverse">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <i class="fa fa-chart-bar me-2"></i>Usage Analytics
                </h4>
                <div class="panel-heading-btn">
                    <button type="button" class="btn btn-xs btn-icon btn-primary" onclick="exportRoleReport()" title="Export Report">
                        <i class="fa fa-download"></i>
                    </button>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload"><i class="fa fa-redo"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse"><i class="fa fa-minus"></i></a>
                </div>
            </div>
            <div class="panel-body">
                <div class="row text-center mb-3">
                    <div class="col-4">
                        <div class="p-2">
                            <div class="fs-20px fw-bold text-primary" id="loginCount">-</div>
                            <div class="fs-11px text-muted">Recent Logins</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-2">
                            <div class="fs-20px fw-bold text-success" id="activityScoreChart">-</div>
                            <div class="fs-11px text-muted">Activity</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-2">
                            <div class="fs-20px fw-bold text-warning">@(Model.IsActive ? "100%" : "0%")</div>
                            <div class="fs-11px text-muted">Health</div>
                        </div>
                    </div>
                </div>

                <!-- Activity Chart Container -->
                <div style="height: 200px;">
                    <canvas id="roleActivityChart"></canvas>
                </div>

                <div class="mt-3 text-center">
                    <small class="text-muted">
                        <i class="fa fa-info-circle me-1"></i>
                        Activity data shows user engagement with this role
                    </small>
                </div>
            </div>
        </div>
        <!-- END panel -->
    </div>
</div>
<!-- END row -->
@section Scripts {
    <script>
        $(document).ready(function() {
            console.log('SecurityRoles Details page initialized');
            loadRoleDetails();
            loadPermissions();
            loadAssignedUsers();
            loadRecentActivity();

            // Only initialize chart if Chart.js is available
            if (typeof Chart !== 'undefined') {
                initializeActivityChart();
            } else {
                $('#roleActivityChart').parent().html('<p class="text-muted text-center">Chart library not available</p>');
            }
        });

        function loadRoleDetails() {
            $.get('@Url.Action("GetRoleStatistics", new { id = Model.Id })')
                .done(function(data) {
                    if (data.success) {
                        $('#permissionCount').text(data.permissionCount || 0);
                        $('#loginCount').text(data.recentLogins || 0);
                        $('#activityScore').text(data.activityScore || 0);
                        $('#activityScoreChart').text(data.activityScore || 0);
                        $('#permissionsBadge').text(data.permissionCount || 0);
                        $('#usersBadge').text(data.userCount || 0);
                    }
                })
                .fail(function() {
                    console.warn('Failed to load role statistics');
                });
        }

        function loadPermissions() {
            $.get('@Url.Action("GetRolePermissions", new { id = Model.Id })')
                .done(function(data) {
                    if (data.success && data.data.length > 0) {
                        let html = '';
                        data.data.slice(0, 8).forEach(function(permission) {
                            html += `
                                <div class="d-flex align-items-center py-2 border-bottom">
                                    <div class="w-35px text-center">
                                        <i class="${permission.icon} text-${permission.color}"></i>
                                    </div>
                                    <div class="flex-fill ps-2">
                                        <div class="fw-bold">${permission.displayName}</div>
                                        <div class="small text-muted">${permission.description}</div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-light text-dark">${permission.permissionType}</span>
                                    </div>
                                </div>`;
                        });

                        if (data.data.length > 8) {
                            html += `
                                <div class="text-center py-3">
                                    <a href="@Url.Action("RolePermissions", new { roleId = Model.Id })" class="btn btn-sm btn-outline-theme">
                                        <i class="fa fa-plus me-1"></i>View All ${data.data.length} Permissions
                                    </a>
                                </div>`;
                        }

                        $('#permissionsContainer').html(html);
                    } else {
                        $('#permissionsContainer').html(`
                            <div class="text-center py-4">
                                <i class="fa fa-key fs-36px text-muted mb-3"></i>
                                <p class="text-muted mb-0">No permissions assigned to this role</p>
                                <a href="@Url.Action("RolePermissions", new { roleId = Model.Id })" class="btn btn-sm btn-outline-theme mt-2">
                                    <i class="fa fa-plus me-1"></i>Assign Permissions
                                </a>
                            </div>
                        `);
                    }
                })
                .fail(function() {
                    $('#permissionsContainer').html('<p class="text-warning mb-0">Failed to load permissions</p>');
                });
        }

        function loadAssignedUsers() {
            $.get('@Url.Action("GetRoleUsers", new { id = Model.Id })')
                .done(function(data) {
                    if (data.success && data.data.length > 0) {
                        let html = '';
                        data.data.forEach(function(user) {
                            const statusBadge = user.isActive ? 'success' : 'secondary';
                            const statusText = user.isActive ? 'Active' : 'Inactive';
                            const initials = user.fullName ? user.fullName.charAt(0).toUpperCase() : '?';

                            html += `
                                <div class="d-flex align-items-center py-2 border-bottom">
                                    <div class="w-40px">
                                        <div class="avatar-initial rounded-circle bg-theme text-white">
                                            ${initials}
                                        </div>
                                    </div>
                                    <div class="flex-fill ps-3">
                                        <div class="fw-bold">${user.fullName || 'No Name'}</div>
                                        <div class="small text-muted">${user.email || 'No email'}</div>
                                        <div class="small text-muted">${user.department || 'No department'}</div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-${statusBadge}">${statusText}</span>
                                        <div class="small text-muted mt-1">Added: ${user.assignedAt}</div>
                                    </div>
                                </div>`;
                        });

                        if (data.data.length >= 10) {
                            html += `
                                <div class="text-center py-3">
                                    <a href="@Url.Action("Index", "SecurityUsers", new { roleId = Model.Id })" class="btn btn-sm btn-outline-theme">
                                        <i class="fa fa-eye me-1"></i>View All Users
                                    </a>
                                </div>`;
                        }

                        $('#usersContainer').html(html);
                    } else {
                        $('#usersContainer').html(`
                            <div class="text-center py-4">
                                <i class="fa fa-users fs-36px text-muted mb-3"></i>
                                <p class="text-muted mb-0">No users assigned to this role</p>
                                <a href="@Url.Action("Index", "SecurityUsers")" class="btn btn-sm btn-outline-theme mt-2">
                                    <i class="fa fa-plus me-1"></i>Assign Users
                                </a>
                            </div>
                        `);
                    }
                })
                .fail(function() {
                    $('#usersContainer').html('<p class="text-warning mb-0">Failed to load users</p>');
                });
        }

        function loadRecentActivity() {
            $.get('@Url.Action("GetRoleActivity", new { id = Model.Id })')
                .done(function(data) {
                    if (data.success && data.data.length > 0) {
                        let html = '';
                        data.data.forEach(function(activity) {
                            const badgeClass = activity.recent ? 'bg-primary' : 'bg-light text-dark';
                            html += `
                                <div class="d-flex align-items-center py-2 border-bottom ${activity.recent ? 'recent' : ''}">
                                    <div class="w-35px text-center">
                                        <span class="badge ${badgeClass}">
                                            <i class="fa fa-clock"></i>
                                        </span>
                                    </div>
                                    <div class="flex-fill ps-2">
                                        <div class="fw-bold">${activity.action}</div>
                                        <div class="small text-muted">${activity.user} • ${activity.timeAgo}</div>
                                    </div>
                                </div>`;
                        });
                        $('#recentActivityContainer').html(html);
                    } else {
                        $('#recentActivityContainer').html(`
                            <div class="text-center py-3">
                                <i class="fa fa-clock fs-24px text-muted mb-2"></i>
                                <p class="text-muted mb-0">No recent activity</p>
                            </div>
                        `);
                    }
                })
                .fail(function() {
                    $('#recentActivityContainer').html('<p class="text-warning mb-0">Failed to load activity</p>');
                });
        }

        function initializeActivityChart() {
            const ctx = document.getElementById('roleActivityChart');
            if (!ctx) return;

            const chartCtx = ctx.getContext('2d');

            // Sample data - replace with actual API call
            const chartData = {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'User Activity',
                    data: [12, 19, 3, 5, 2, 3, 7],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            };

            new Chart(chartCtx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function exportRoleReport() {
            // Check if custom alert system exists, otherwise use native confirm
            if (typeof alert !== 'undefined' && alert.confirm) {
                alert.confirm('Export Role Report', 'Generate a detailed report for this role?', function() {
                    window.location.href = '@Url.Action("ExportRoleReport", new { id = Model.Id })';
                });
            } else {
                if (confirm('Generate a detailed report for this role?')) {
                    window.location.href = '@Url.Action("ExportRoleReport", new { id = Model.Id })';
                }
            }
        }

        // Add custom CSS for styling
        $('<style>')
            .prop('type', 'text/css')
            .html(`
                .avatar-initial {
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    font-size: 14px;
                }
                .recent {
                    background-color: rgba(102, 126, 234, 0.05);
                }
                .w-35px { width: 35px; }
                .w-40px { width: 40px; }
                .fs-36px { font-size: 36px; }
                .fs-24px { font-size: 24px; }
                .fs-20px { font-size: 20px; }
                .fs-18px { font-size: 18px; }
                .fs-14px { font-size: 14px; }
                .fs-12px { font-size: 12px; }
                .fs-11px { font-size: 11px; }
            `)
            .appendTo('head');
    </script>
}