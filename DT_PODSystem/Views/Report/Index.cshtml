@model QueryResultReportViewModel
@{
    ViewData["Title"] = "Query Results Report";
}

@section Styles {
    <link href="https://ops_cdn.stc.com.sa/ca/plugins/datatables.net-bs5/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <link href="https://ops_cdn.stc.com.sa/ca/plugins/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css" rel="stylesheet" />
    <link href="https://ops_cdn.stc.com.sa/ca/plugins/datatables.net-buttons-bs5/css/buttons.bootstrap5.min.css" rel="stylesheet" />
    
}

<!-- BEGIN breadcrumb -->
<ol class="breadcrumb float-xl-end">
    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Dashboard</a></li>
    <li class="breadcrumb-item active">Query Results Report</li>
</ol>
<!-- END breadcrumb -->
<!-- BEGIN page-header -->
<h1 class="page-header">Query Results Report <small>View and analyze calculated query outputs</small></h1>
<!-- END page-header -->
<!-- BEGIN row -->
<div class="row">
    <div class="col-xl-3 col-md-6">
        <div class="widget widget-stats bg-blue">
            <div class="stats-icon"><i class="fa fa-calculator"></i></div>
            <div class="stats-info">
                <h4>TOTAL RESULTS</h4>
                <p>@Model.Summary.TotalResults.ToString("N0")</p>
            </div>
            <div class="stats-link">
                <a href="javascript:;">View All <i class="fa fa-arrow-alt-circle-right"></i></a>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="widget widget-stats bg-green">
            <div class="stats-icon"><i class="fa fa-check-circle"></i></div>
            <div class="stats-info">
                <h4>VALID RESULTS</h4>
                <p>@Model.Summary.ValidResults.ToString("N0")</p>
            </div>
            <div class="stats-link">
                <a href="javascript:;">@Model.Summary.ValidPercentage.ToString("F1")% success <i class="fa fa-arrow-alt-circle-right"></i></a>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="widget widget-stats bg-orange">
            <div class="stats-icon"><i class="fa fa-thumbs-up"></i></div>
            <div class="stats-info">
                <h4>APPROVED</h4>
                <p>@Model.Summary.ApprovedResults.ToString("N0")</p>
            </div>
            <div class="stats-link">
                <a href="javascript:;">@Model.Summary.ApprovalPercentage.ToString("F1")% approved <i class="fa fa-arrow-alt-circle-right"></i></a>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="widget widget-stats bg-red">
            <div class="stats-icon"><i class="fa fa-tachometer-alt"></i></div>
            <div class="stats-info">
                <h4>CONFIDENCE</h4>
                <p>@Model.Summary.AverageConfidence.ToString("P1")</p>
            </div>
            <div class="stats-link">
                <a href="javascript:;">@Model.Summary.AverageExecutionTime.ToString("F0")ms avg <i class="fa fa-arrow-alt-circle-right"></i></a>
            </div>
        </div>
    </div>
</div>
<!-- END row -->
<!-- BEGIN panel -->
<div class="panel panel-inverse">
    <div class="panel-heading">
        <h4 class="panel-title">Filters</h4>
        <div class="panel-heading-btn">
            <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>
            <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse"><i class="fa fa-minus"></i></a>
        </div>
    </div>
    <div class="panel-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Period</label>
                <select id="periodFilter" class="form-select">
                    <option value="">All Periods</option>
                    @foreach (var period in Model.Filters.PeriodOptions)
                    {
                        <option value="@period.Value">@period.Text</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Query</label>
                <select id="queryFilter" class="form-select">
                    <option value="">All Queries</option>
                    @foreach (var query in Model.Filters.QueryOptions)
                    {
                        <option value="@query.Value">@query.Text</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Category</label>
                <select id="categoryFilter" class="form-select">
                    <option value="">All Categories</option>
                    @foreach (var category in Model.Filters.CategoryOptions)
                    {
                        <option value="@category.Value">@category.Text</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select id="statusFilter" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="valid">Valid</option>
                    <option value="invalid">Invalid</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                </select>
            </div>
        </div>
    </div>
</div>
<!-- END panel -->
<!-- BEGIN panel -->
<div class="panel panel-inverse">
    <div class="panel-heading">
        <h4 class="panel-title">Query Results</h4>
        <div class="panel-heading-btn">
            @if (Model.CanExport)
            {
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-xs btn-success dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fa fa-download"></i> Export
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportData('excel')">Excel</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportData('csv')">CSV</a></li>
                    </ul>
                </div>
            }
            <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>
            <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload"><i class="fa fa-redo"></i></a>
            <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse"><i class="fa fa-minus"></i></a>
        </div>
    </div>
    <div class="panel-body">
        <div class="table-responsive">
            <table id="queryResultsTable" class="table table-striped table-bordered align-middle w-100">
                <thead>
                    <tr>
                        <th>Period</th>
                        <th>Query</th>
                        <th>Output</th>
                        <th>Value</th>
                        <th>File</th>
                        <th>Category</th>
                        <th>Vendor</th>
                        <th>Executed</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<!-- END panel -->
@section Scripts {
    <!-- DataTables Core -->
    <script src="https://ops_cdn.stc.com.sa/ca/plugins/datatables.net/js/dataTables.min.js"></script>
    <script src="https://ops_cdn.stc.com.sa/ca/plugins/datatables.net-bs5/js/dataTables.bootstrap5.min.js"></script>

    <!-- Responsive -->
    <script src="https://ops_cdn.stc.com.sa/ca/plugins/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="https://ops_cdn.stc.com.sa/ca/plugins/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js"></script>

    <!-- Buttons -->
    <script src="https://ops_cdn.stc.com.sa/ca/plugins/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="https://ops_cdn.stc.com.sa/ca/plugins/datatables.net-buttons-bs5/js/buttons.bootstrap5.min.js"></script>
    <script src="https://ops_cdn.stc.com.sa/ca/plugins/datatables.net-buttons/js/buttons.colVis.min.js"></script>
    <script src="https://ops_cdn.stc.com.sa/ca/plugins/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="https://ops_cdn.stc.com.sa/ca/plugins/datatables.net-buttons/js/buttons.print.min.js"></script>

    <!-- Export dependencies -->
    <script src="https://ops_cdn.stc.com.sa/ca/plugins/pdfmake/build/pdfmake.min.js"></script>
    <script src="https://ops_cdn.stc.com.sa/ca/plugins/pdfmake/build/vfs_fonts.js"></script>
    <script src="https://ops_cdn.stc.com.sa/ca/plugins/jszip/dist/jszip.min.js"></script>

    <script>
        $(document).ready(function() {
            var table = $('#queryResultsTable').DataTable({
                processing: true,
                serverSide: true,
                responsive: true,
                ajax: {
                    url: '@Url.Action("GetQueryResultsData")',
                    type: 'POST',
                    data: function(d) {
                        d.periodFilter = $('#periodFilter').val();
                        d.queryFilter = $('#queryFilter').val();
                        d.categoryFilter = $('#categoryFilter').val();
                        d.statusFilter = $('#statusFilter').val();
                    }
                },
                columns: [
                    { data: 'periodDisplay' },
                    { data: 'queryName' },
                    { data: 'outputName' },
                    {
                        data: 'calculatedValue',
                        render: function(data, type, row) {
                            if (row.outputDataType === 'Currency') {
                                return '<span class="text-success fw-bold">$' + parseFloat(data).toLocaleString() + '</span>';
                            }
                            return data;
                        }
                    },
                    { data: 'originalFileName' },
                    { data: 'categoryName' },
                    { data: 'vendorName' },
                    {
                        data: 'executedDate',
                        render: function(data) {
                            return new Date(data).toLocaleDateString();
                        }
                    },
                    {
                        data: 'isValid',
                        render: function(data) {
                            return data ? '<span class="badge bg-success">Valid</span>' : '<span class="badge bg-danger">Invalid</span>';
                        }
                    },
                    {
                        data: 'id',
                        orderable: false,
                        searchable: false,
                        render: function(data) {
                            return '<button class="btn btn-xs btn-blue" onclick="showDetails(' + data + ')"><i class="fa fa-eye"></i></button>';
                        }
                    }
                ],
                order: [[7, 'desc']],
                pageLength: 25,
                 dom: '<"row mb-4"<"col-md-6"B><"col-md-6"f>>rtip',
        buttons: [
            {
                extend: 'pageLength',
                className: 'btn-dark' // Page length dropdown
            },
            {
                extend: 'colvis',
                className: 'btn-purple', // Column visibility
                text: '<i class="fa fa-columns"></i>'
            },
            {
                extend: 'excel',
                className: 'btn-success', // Green for Excel (success/go)
                text: '<i class="fa fa-file-excel"></i>'
            } 
             
        ],
            });

            $('#periodFilter, #queryFilter, #categoryFilter, #statusFilter').change(function() {
                table.ajax.reload();
            });
        });

        function showDetails(id) {
            $.get('@Url.Action("Details")/' + id, function(data) {
                alert('Details for ID: ' + id);
            });
        }

        function exportData(format) {
            var form = $('<form>', {
                method: 'POST',
                action: '@Url.Action("Export")'
            });

            form.append($('<input>', { type: 'hidden', name: 'periodFilter', value: $('#periodFilter').val() }));
            form.append($('<input>', { type: 'hidden', name: 'queryFilter', value: $('#queryFilter').val() }));
            form.append($('<input>', { type: 'hidden', name: 'categoryFilter', value: $('#categoryFilter').val() }));
            form.append($('<input>', { type: 'hidden', name: 'statusFilter', value: $('#statusFilter').val() }));
            form.append($('<input>', { type: 'hidden', name: 'format', value: format }));

            form.appendTo('body').submit().remove();
        }
    </script>
}